# Ashray Psychology App - Authentication Guide

## Overview

Ashray uses Firebase Authentication for a secure, production-ready authentication system with support for:
- OAuth2 social login (Google, Apple)
- Multi-factor authentication (TOTP/SMS)
- Biometric authentication (Face ID, Touch ID, fingerprint)
- Secure JWT token management
- Account recovery flows
- HIPAA-compliant audit logging

## Architecture

### Backend (Node.js/Express)
- Firebase Admin SDK for server-side authentication
- JWT token validation middleware
- Redis for session management
- Speakeasy for TOTP generation
- Comprehensive audit logging

### Frontend (Flutter)
- Firebase Auth SDK for client authentication
- Secure storage for tokens
- Biometric authentication support
- Platform-specific OAuth implementations

### Web (React)
- Firebase JS SDK
- WebAuthn support for biometrics
- Session persistence with secure cookies

## Setup Instructions

### 1. Firebase Project Setup

1. Create a new Firebase project at https://console.firebase.google.com
2. Enable Authentication service
3. Configure OAuth providers:
   - Google Sign-In
   - Apple Sign-In (requires Apple Developer account)
4. Enable MFA options:
   - SMS verification
   - TOTP authenticator apps

### 2. Environment Configuration

#### Backend (.env)
```bash
# Firebase Admin SDK
FIREBASE_PROJECT_ID=your-project-id
FIREBASE_PRIVATE_KEY_ID=your-private-key-id
FIREBASE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----\n"
FIREBASE_CLIENT_EMAIL=your-service-account@project.iam.gserviceaccount.com
FIREBASE_CLIENT_ID=your-client-id
FIREBASE_AUTH_URI=https://accounts.google.com/o/oauth2/auth
FIREBASE_TOKEN_URI=https://oauth2.googleapis.com/token
FIREBASE_AUTH_PROVIDER_X509_CERT_URL=https://www.googleapis.com/oauth2/v1/certs
FIREBASE_CLIENT_X509_CERT_URL=your-cert-url

# Redis for session management
REDIS_URL=redis://localhost:6379
REDIS_PASSWORD=your-redis-password

# Email service for MFA and recovery
EMAIL_FROM=noreply@ashrayapp.com
SENDGRID_API_KEY=your-sendgrid-key

# JWT Configuration
JWT_ACCESS_SECRET=your-access-token-secret
JWT_REFRESH_SECRET=your-refresh-token-secret
JWT_ACCESS_EXPIRY=15m
JWT_REFRESH_EXPIRY=7d
```

#### Flutter (firebase_options.dart)
```dart
// Generated by FlutterFire CLI
// Run: flutterfire configure
```

### 3. Implementation Details

#### Authentication Flow

1. **Initial Login**
   ```
   Client → Firebase Auth → Backend validation → JWT tokens → Client storage
   ```

2. **MFA Flow**
   ```
   Login → MFA required → SMS/TOTP challenge → Verification → Access granted
   ```

3. **Token Refresh**
   ```
   Access token expired → Refresh token → New access token → Continue
   ```

#### Security Features

1. **Token Rotation**
   - Access tokens: 15-minute expiry
   - Refresh tokens: 7-day expiry with rotation
   - Automatic revocation on suspicious activity

2. **Biometric Authentication**
   - Optional second factor
   - Stored securely in device keychain
   - Falls back to PIN/password

3. **Account Recovery**
   - Email-based password reset
   - MFA recovery codes
   - Identity verification for locked accounts

## API Endpoints

### Authentication Routes

```typescript
POST   /api/auth/register          - New user registration
POST   /api/auth/login            - User login
POST   /api/auth/logout           - User logout
POST   /api/auth/refresh          - Refresh access token
POST   /api/auth/verify-email     - Email verification
POST   /api/auth/reset-password   - Password reset request
POST   /api/auth/confirm-reset    - Confirm password reset
POST   /api/auth/mfa/enable       - Enable MFA
POST   /api/auth/mfa/verify       - Verify MFA code
POST   /api/auth/mfa/disable      - Disable MFA
GET    /api/auth/mfa/recovery     - Get recovery codes
POST   /api/auth/biometric/enroll - Enroll biometric auth
POST   /api/auth/biometric/verify - Verify biometric auth
```

### Request/Response Examples

#### Registration
```bash
POST /api/auth/register
{
  "email": "user@example.com",
  "password": "SecurePassword123!",
  "name": "John Doe",
  "acceptedTerms": true
}

Response:
{
  "user": {
    "uid": "firebase-uid",
    "email": "user@example.com",
    "name": "John Doe"
  },
  "tokens": {
    "accessToken": "jwt...",
    "refreshToken": "jwt...",
    "expiresIn": 900
  }
}
```

#### OAuth Login
```bash
POST /api/auth/login
{
  "provider": "google",
  "idToken": "google-id-token"
}
```

#### MFA Verification
```bash
POST /api/auth/mfa/verify
{
  "code": "123456",
  "sessionToken": "temp-session-token"
}
```

## Flutter Integration

### Setup
```dart
// Initialize Firebase
await Firebase.initializeApp(
  options: DefaultFirebaseOptions.currentPlatform,
);

// Initialize Auth Service
final authService = AuthService();
await authService.initialize();
```

### Usage Examples

#### Email/Password Login
```dart
try {
  final result = await authService.signInWithEmail(
    email: 'user@example.com',
    password: 'password123',
  );
  
  if (result.requiresMFA) {
    // Navigate to MFA screen
    Navigator.push(context, MFAVerificationScreen.route(result.sessionToken));
  } else {
    // Navigate to home
    Navigator.pushReplacementNamed(context, '/home');
  }
} catch (e) {
  // Handle error
}
```

#### Social Login
```dart
// Google Sign-In
await authService.signInWithGoogle();

// Apple Sign-In
await authService.signInWithApple();
```

#### Biometric Authentication
```dart
// Check availability
final canUseBiometrics = await authService.canCheckBiometrics();

// Enroll
if (canUseBiometrics) {
  await authService.enrollBiometric();
}

// Authenticate
final authenticated = await authService.authenticateWithBiometric();
```

## Security Best Practices

1. **Password Requirements**
   - Minimum 8 characters
   - At least one uppercase, lowercase, number, and special character
   - Check against common passwords
   - Implement rate limiting

2. **Session Management**
   - Secure, httpOnly cookies for web
   - Encrypted storage for mobile
   - Automatic session timeout
   - Device tracking and alerts

3. **MFA Enforcement**
   - Required for admin accounts
   - Recommended for all users
   - Backup recovery codes
   - Remember device option

4. **Audit Logging**
   - All authentication events logged
   - Failed login attempts tracked
   - Suspicious activity monitoring
   - HIPAA-compliant retention

## Troubleshooting

### Common Issues

1. **Firebase initialization fails**
   - Verify service account credentials
   - Check Firebase project settings
   - Ensure APIs are enabled

2. **OAuth redirect issues**
   - Verify redirect URLs in Firebase console
   - Check platform-specific configurations
   - Update OAuth consent screen

3. **MFA not working**
   - Ensure phone auth is enabled
   - Check SMS quota limits
   - Verify TOTP time sync

4. **Token validation errors**
   - Check token expiry
   - Verify JWT secrets match
   - Ensure clock sync between servers

### Debug Mode

Enable debug logging:
```typescript
// Backend
process.env.AUTH_DEBUG = 'true';

// Flutter
AuthService.enableDebugMode();
```

## Compliance

### HIPAA Requirements
- Encrypted data transmission (TLS 1.3)
- Audit logs for all access
- Automatic session timeout (30 minutes)
- Strong password requirements
- MFA for privileged accounts

### GDPR Compliance
- Explicit consent for data processing
- Right to erasure implementation
- Data portability support
- Privacy by design

## Support

For authentication issues:
1. Check system status: https://status.ashrayapp.com
2. Review audit logs in admin dashboard
3. Contact support: support@ashrayapp.com

## Version History

- v1.0.0 - Initial Firebase Auth implementation
- v1.1.0 - Added MFA support
- v1.2.0 - Biometric authentication
- v1.3.0 - Enhanced security features
